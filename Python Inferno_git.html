<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PichaTime Studio</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Patrick+Hand&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-app: #1e1e1e;
            --bg-sidebar: #252526;
            --bg-header: #2d2d2d;
            --text-main: #e0e0e0;
            --text-muted: #858585;
            --accent: #007acc;
            --border: #383838;
            --font-ui: 'Segoe UI', system-ui, sans-serif;
            --font-note: 'Patrick Hand', cursive;
            /* Playful Font */
            --shadow-rest: 0 1px 3px rgba(0, 0, 0, 0.12), 0 1px 2px rgba(0, 0, 0, 0.24);
            --shadow-lift: 0 14px 28px rgba(0, 0, 0, 0.25), 0 10px 10px rgba(0, 0, 0, 0.22);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            outline: none;
        }

        body {
            font-family: var(--font-ui);
            background-color: var(--bg-app);
            color: var(--text-main);
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            display: flex;
            touch-action: none;
        }

        /* --- SIDEBAR --- */
        #sidebar {
            width: 260px;
            background: var(--bg-sidebar);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            transition: transform 0.3s ease, width 0.3s ease;
            z-index: 10;
        }

        .sidebar-header {
            padding: 15px;
            background: #181818;
            border-bottom: 1px solid var(--border);
        }

        .app-title {
            font-weight: 700;
            font-size: 0.9rem;
            margin-bottom: 15px;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .file-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 5px;
        }

        .file-actions button {
            background: #333;
            border: 1px solid #444;
            color: #ccc;
            padding: 5px;
            font-size: 0.75rem;
            cursor: pointer;
            border-radius: 3px;
        }

        .file-actions button:hover {
            background: #444;
            color: white;
        }

        .file-actions button.primary {
            border-color: var(--accent);
            color: var(--accent);
        }

        #file-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px 0;
        }

        .file-item {
            padding: 8px 15px;
            cursor: pointer;
            border-left: 3px solid transparent;
            display: flex;
            flex-direction: column;
            transition: background 0.1s;
        }

        .file-item:hover {
            background: #2a2d2e;
        }

        .file-item.active {
            background: #37373d;
            border-left-color: var(--accent);
        }

        .file-name {
            font-size: 0.9rem;
            color: #fff;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .file-meta {
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-top: 3px;
        }

        .file-opt {
            opacity: 0;
            transition: opacity 0.2s;
        }

        .file-item:hover .file-opt {
            opacity: 1;
        }

        .file-opt i:hover {
            color: #ff4757;
        }

        /* --- MAIN AREA --- */
        #main-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
            min-width: 0;
            transition: margin 0.3s ease;
        }

        /* --- TOOLBAR --- */
        #toolbar {
            height: 46px;
            background: var(--bg-header);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            padding: 0 15px;
            gap: 10px;
            flex-shrink: 0;
            transition: transform 0.3s ease;
        }

        .tab-switcher {
            display: flex;
            background: #222;
            border-radius: 4px;
            padding: 2px;
            border: 1px solid #333;
            margin-right: 15px;
        }

        .tab-btn {
            padding: 4px 12px;
            border: none;
            background: transparent;
            color: #888;
            cursor: pointer;
            font-size: 0.8rem;
            border-radius: 3px;
            font-weight: 600;
        }

        .tab-btn.active {
            background: #3c3c3c;
            color: #fff;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }

        .tool-group {
            display: flex;
            align-items: center;
            gap: 4px;
            border-right: 1px solid #444;
            padding-right: 10px;
            margin-right: 5px;
        }

        .tool-btn {
            background: transparent;
            border: 1px solid transparent;
            color: #ccc;
            width: 28px;
            height: 28px;
            border-radius: 3px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .tool-btn:hover {
            background: #444;
        }

        /* --- ZEN MODE STYLES --- */
        body.zen-active #sidebar {
            transform: translateX(-100%);
            width: 0;
            border: none;
        }

        body.zen-active #toolbar {
            transform: translateY(-100%);
            height: 0;
            overflow: hidden;
            padding: 0;
            border: none;
        }

        #exit-zen-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: 1px solid #555;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            z-index: 9999;
            display: none;
            font-size: 0.8rem;
            backdrop-filter: blur(5px);
        }

        body.zen-active #exit-zen-btn {
            display: block;
        }

        /* --- VIEWS --- */
        .view-layer {
            flex: 1;
            position: relative;
            display: none;
            overflow: hidden;
        }

        .view-layer.active {
            display: block;
        }

        /* MOODBOARD */
        #mb-viewport {
            width: 100%;
            height: 100%;
            overflow: auto;
            background: #111;
            position: relative;
            cursor: default;
        }

        /* MASSIVE CANVAS FIX */
        #mb-canvas {
            width: 15000px;
            /* Increased from 5000px to cover zoom-out */
            height: 15000px;
            background-color: #151515;
            background-image: radial-gradient(#3a3a3a 1.5px, transparent 1.5px);
            background-size: 25px 25px;
            position: relative;
            transform-origin: 0 0;
        }

        /* --- MATERIAL DESIGN ITEMS --- */
        .mb-item {
            position: absolute;
            min-width: 50px;
            min-height: 50px;
            border-radius: 6px;
            cursor: default;
            transition: box-shadow 0.2s, transform 0.2s;
            box-shadow: var(--shadow-rest);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .mb-item.selected {
            box-shadow: var(--shadow-lift);
            transform: scale(1.01);
            z-index: 100;
            outline: 2px solid var(--accent);
            outline-offset: 2px;
        }

        /* NOTE STRUCTURE */
        .mb-note {
            background: #444;
            color: #222;
            /* Darker text for better contrast on pastel */
        }

        .drag-handle-bar {
            height: 20px;
            width: 100%;
            cursor: grab;
            background: rgba(0, 0, 0, 0.05);
            flex-shrink: 0;
        }

        .drag-handle-bar:active {
            cursor: grabbing;
        }

        .note-content {
            flex: 1;
            padding: 5px 15px 15px 15px;
            font-family: var(--font-note);
            /* PATRICK HAND FONT */
            font-size: 1.3rem;
            /* Slightly larger for handwritten feel */
            line-height: 1.4;
            overflow-y: auto;
            cursor: text;
        }

        .note-content:empty:before {
            content: "Type here...";
            color: rgba(0, 0, 0, 0.3);
        }

        .mb-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            pointer-events: none;
            border-radius: 6px;
        }

        .resize-handle {
            width: 16px;
            height: 16px;
            background: var(--accent);
            border: 2px solid #fff;
            border-radius: 50%;
            position: absolute;
            bottom: 4px;
            right: 4px;
            cursor: se-resize;
            opacity: 0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            transition: opacity 0.2s;
            z-index: 10;
        }

        .mb-item:hover .resize-handle {
            opacity: 1;
        }

        /* NOTEPAD */
        #notepad-container {
            height: 100%;
            overflow-y: auto;
            background: #1e1e1e;
            display: flex;
            justify-content: center;
        }

        #notepad-editor {
            width: 100%;
            max-width: 850px;
            padding: 50px;
            color: #d4d4d4;
            outline: none;
            font-size: 1.1rem;
            line-height: 1.6;
            min-height: 100%;
        }

        #notepad-editor h1 {
            border-bottom: 1px solid #444;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        #toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--accent);
            color: white;
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 0.8rem;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 9999;
            pointer-events: none;
        }
    </style>
</head>

<body>

    <div id="sidebar">
        <div class="sidebar-header">
            <div class="app-title"><i class="fas fa-book-open"></i> NOTE_INDEX</div>
            <div class="file-actions">
                <button class="primary" onclick="createProject()" title="New Project"><i class="fas fa-plus"></i>
                    New</button>
                <button onclick="saveSelf()" title="Save HTML"><i class="fas fa-save"></i> Save</button>
                <button onclick="exportProject()" title="Export JSON"><i class="fas fa-file-export"></i> Exp</button>
                <button onclick="triggerImport()" title="Import JSON"><i class="fas fa-file-import"></i> Imp</button>
                <button onclick="backupAll()" title="Backup All"><i class="fas fa-archive"></i> Bkp</button>
            </div>
        </div>
        <div id="file-list"></div>
    </div>

    <div id="main-area">

        <div id="toolbar">
            <div class="tab-switcher">
                <button class="tab-btn active" id="btn-moodboard" onclick="switchTab('moodboard')">Moodboard</button>
                <button class="tab-btn" id="btn-notepad" onclick="switchTab('notepad')">Notebook</button>
            </div>

            <div class="tool-group">
                <button class="tool-btn" onclick="execCmd('bold')" title="Bold"><i class="fas fa-bold"></i></button>
                <button class="tool-btn" onclick="execCmd('italic')" title="Italic"><i
                        class="fas fa-italic"></i></button>
                <button class="tool-btn" onclick="execCmd('underline')" title="Underline"><i
                        class="fas fa-underline"></i></button>
                <div
                    style="position:relative; width:28px; height:28px; display:flex; align-items:center; justify-content:center;">
                    <i class="fas fa-palette"
                        style="color:#ccc; font-size:14px; position:absolute; pointer-events:none;"></i>
                    <input type="color" onchange="applyColor(this.value)" title="Color"
                        style="opacity:0; width:100%; height:100%; cursor:pointer;">
                </div>
            </div>

            <div class="tool-group">
                <select onchange="execCmd('formatBlock', this.value)"
                    style="background:#333;color:#ccc;border:1px solid #444;">
                    <option value="p">Normal</option>
                    <option value="h1">Header 1</option>
                    <option value="h2">Header 2</option>
                    <option value="blockquote">Quote</option>
                </select>
                <select onchange="execCmd('fontSize', this.value)"
                    style="background:#333;color:#ccc;border:1px solid #444;">
                    <option value="3">Size</option>
                    <option value="1">Small</option>
                    <option value="5">Big</option>
                    <option value="7">Huge</option>
                </select>
            </div>

            <div style="flex:1"></div>

            <div class="tool-group">
                <button class="tool-btn" onclick="toggleZen()" title="Zen Mode (Spacebar)"><i
                        class="fas fa-expand"></i></button>
                <button class="tool-btn" onclick="addStickyNote()" title="Sticky Note"><i
                        class="fas fa-sticky-note"></i></button>
                <button class="tool-btn" onclick="document.getElementById('img-input').click()" title="Image"><i
                        class="fas fa-image"></i></button>
                <button class="tool-btn" onclick="centerCanvas()" title="Center"><i
                        class="fas fa-compress-arrows-alt"></i></button>
            </div>
        </div>

        <button id="exit-zen-btn" onclick="toggleZen()">Exit Zen Mode (ESC)</button>

        <div id="view-moodboard" class="view-layer active">
            <div id="mb-viewport">
                <div id="mb-canvas"></div>
            </div>
        </div>

        <div id="view-notepad" class="view-layer">
            <div id="notepad-container">
                <div id="notepad-editor" contenteditable="true" spellcheck="false"></div>
            </div>
        </div>
    </div>

    <input type="file" id="img-input" style="display:none" accept="image/*" multiple onchange="handleImageUpload(this)">
    <input type="file" id="json-input" style="display:none" accept=".json" onchange="handleImport(this)">
    <div id="toast"></div>
    <script id="app-data" type="application/json">{"projects":[]}</script>

    <script>
        // --- CORE DATA ---
        let projects = [];
        let activeProjectId = null;
        let activeTab = 'moodboard';
        let zoomLevel = 1;

        const calmColors = ['#ffecb3', '#dcedc8', '#b3e5fc', '#e1bee7', '#ffcdd2', '#f5f5f5'];

        // --- INIT ---
        window.onload = () => {
            loadData();
            if (projects.length === 0) createProject("Note_index");
            else loadProject(projects[0].id);
        };

        // --- KEYBOARD HANDLER ---
        document.addEventListener('keydown', (e) => {
            // 1. ESC -> Exit Zen
            if (e.key === 'Escape' && document.body.classList.contains('zen-active')) {
                toggleZen();
                return;
            }

            // 2. Alt/Ctrl + Tab -> Switch View
            if (e.key === 'Tab' && (e.altKey || e.ctrlKey || e.metaKey)) {
                e.preventDefault();
                const newTab = activeTab === 'moodboard' ? 'notepad' : 'moodboard';
                switchTab(newTab);
                showToast(`Switched to: ${newTab.charAt(0).toUpperCase() + newTab.slice(1)}`);
                return;
            }

            // 3. DELETE -> Remove Selected Item
            const isTyping = e.target.tagName === 'INPUT' ||
                e.target.tagName === 'TEXTAREA' ||
                e.target.isContentEditable;

            if (e.key === 'Delete' && !isTyping && activeTab === 'moodboard') {
                const selected = document.querySelector('.mb-item.selected');
                if (selected) {
                    selected.remove();
                    saveCurrent();
                    showToast("Item deleted");
                }
                return;
            }

            // 4. SPACE -> Zen Mode
            if (e.code === 'Space' && !isTyping) {
                e.preventDefault();
                toggleZen();
            }
        });

        function toggleZen() {
            document.body.classList.toggle('zen-active');
            window.dispatchEvent(new Event('resize'));
        }

        // --- MOUSE ZOOM ---
        const mbViewport = document.getElementById('mb-viewport');
        const mbCanvas = document.getElementById('mb-canvas');

        mbViewport.addEventListener('wheel', (e) => {
            if (e.ctrlKey) {
                e.preventDefault();
                e.stopPropagation();

                const rect = mbCanvas.getBoundingClientRect();
                const mouseX = (e.clientX - rect.left) / zoomLevel;
                const mouseY = (e.clientY - rect.top) / zoomLevel;

                const delta = -e.deltaY;
                const newZoom = Math.min(Math.max(0.1, zoomLevel + (delta > 0 ? 0.1 : -0.1)), 5);
                zoomLevel = newZoom;
                mbCanvas.style.transform = `scale(${zoomLevel})`;

                // Center zoom correction
                const viewportMouseX = e.clientX - mbViewport.getBoundingClientRect().left;
                const viewportMouseY = e.clientY - mbViewport.getBoundingClientRect().top;

                mbViewport.scrollLeft = (mouseX * newZoom) - viewportMouseX;
                mbViewport.scrollTop = (mouseY * newZoom) - viewportMouseY;

                showToast(`Zoom: ${Math.round(zoomLevel * 100)}%`);
            }
        }, { passive: false });

        function centerCanvas() {
            // Center of 15000px canvas
            mbViewport.scrollLeft = (15000 - mbViewport.clientWidth) / 2;
            mbViewport.scrollTop = (15000 - mbViewport.clientHeight) / 2;
            zoomLevel = 1;
            mbCanvas.style.transform = `scale(1)`;
        }

        // --- PROJECT MANAGEMENT ---
        function createProject(nameOverride) {
            saveCurrent();
            const id = 'p' + Date.now();
            const name = nameOverride || prompt("Project Name:", "New Project");
            if (!name) return;

            // Default Gray Note at center of 15000x15000
            const cx = 7500;
            const cy = 7500;

            const defaultNote = `
                <div class="mb-item mb-note" style="left: ${cx - 150}px; top: ${cy - 150}px; width: 300px; height: 300px; background-color: #444;">
                    <div class="drag-handle-bar"></div>
                    <div class="note-content" contenteditable="true">
                        <b>${name}</b><br>Start dragging this gray square...
                    </div>
                    <div class="resize-handle"></div>
                </div>
            `;

            projects.unshift({
                id, name,
                timestamp: Date.now(),
                noteHTML: `<h1>${name}</h1><p>Start here...</p>`,
                boardHTML: defaultNote,
                zoom: 1
            });
            renderSidebar();
            loadProject(id);
        }

        function loadProject(id) {
            saveCurrent();
            const p = projects.find(x => x.id === id);
            if (!p) return;
            activeProjectId = id;

            document.getElementById('notepad-editor').innerHTML = p.noteHTML;
            document.getElementById('mb-canvas').innerHTML = p.boardHTML;
            zoomLevel = p.zoom || 1;
            mbCanvas.style.transform = `scale(${zoomLevel})`;

            // Re-attach listeners
            document.querySelectorAll('.mb-item').forEach(el => setupItemInteractions(el));

            renderSidebar();
            centerCanvas();
        }

        function saveCurrent() {
            if (!activeProjectId) return;
            const p = projects.find(x => x.id === activeProjectId);
            if (p) {
                p.noteHTML = document.getElementById('notepad-editor').innerHTML;
                p.boardHTML = document.getElementById('mb-canvas').innerHTML;
                p.zoom = zoomLevel;
                p.timestamp = Date.now();
                saveLocal();
            }
        }

        function renderSidebar() {
            const list = document.getElementById('file-list');
            list.innerHTML = '';
            projects.forEach(p => {
                const el = document.createElement('div');
                el.className = `file-item ${p.id === activeProjectId ? 'active' : ''}`;
                el.innerHTML = `
                    <div class="file-name">${p.name} <div class="file-opt"><i class="fas fa-trash" onclick="deleteProj(event, '${p.id}')"></i></div></div>
                    <div class="file-meta">${new Date(p.timestamp).toLocaleDateString()}</div>
                `;
                el.onclick = () => loadProject(p.id);
                list.appendChild(el);
            });
        }

        function deleteProj(e, id) {
            e.stopPropagation();
            if (!confirm("Delete?")) return;
            projects = projects.filter(p => p.id !== id);
            if (projects.length === 0) createProject("Note_index");
            else loadProject(projects[0].id);
        }

        // --- CREATION ---
        function addStickyNote() {
            const x = (mbViewport.scrollLeft + mbViewport.clientWidth / 2) / zoomLevel - 125;
            const y = (mbViewport.scrollTop + mbViewport.clientHeight / 2) / zoomLevel - 125;
            createStickyAt(x, y);
        }

        function createStickyAt(x, y) {
            switchTab('moodboard');

            // Calculate Index
            const count = document.querySelectorAll('.mb-note').length + 1;
            const title = `Note_${count}`;

            const el = document.createElement('div');
            el.className = 'mb-item mb-note';
            el.style.left = x + 'px'; el.style.top = y + 'px';
            // Square Start
            el.style.width = '250px';
            el.style.height = '250px';

            const randomColor = calmColors[Math.floor(Math.random() * calmColors.length)];
            el.style.backgroundColor = randomColor;

            el.innerHTML = `
                <div class="drag-handle-bar"></div>
                <div class="note-content" contenteditable="true"><b>${title}</b><br></div>
                <div class="resize-handle"></div>
            `;

            setupItemInteractions(el);
            mbCanvas.appendChild(el);

            // Focus and Blink Cursor
            setTimeout(() => {
                const content = el.querySelector('.note-content');
                content.focus();
                // Place cursor at end
                const range = document.createRange();
                range.selectNodeContents(content);
                range.collapse(false);
                const sel = window.getSelection();
                sel.removeAllRanges();
                sel.addRange(range);
            }, 50);
        }

        function handleImageUpload(input) {
            if (!input.files.length) return;
            switchTab('moodboard');
            const file = input.files[0];
            const reader = new FileReader();
            reader.onload = (e) => {
                const el = document.createElement('div');
                el.className = 'mb-item mb-image';
                const x = (mbViewport.scrollLeft + mbViewport.clientWidth / 2) / zoomLevel - 125;
                const y = (mbViewport.scrollTop + mbViewport.clientHeight / 2) / zoomLevel - 100;
                el.style.left = x + 'px'; el.style.top = y + 'px';
                el.style.width = '250px';
                el.innerHTML = `<div class="drag-handle-bar" style="position:absolute;top:0;height:100%;opacity:0;"></div><img src="${e.target.result}"><div class="resize-handle"></div>`;
                setupItemInteractions(el);
                mbCanvas.appendChild(el);
            };
            reader.readAsDataURL(file);
            input.value = '';
        }

        // --- INTERACTION ---
        let dragged = null;
        let resizing = null;
        let dx = 0, dy = 0;
        let r_w = 0, r_h = 0, r_mx = 0, r_my = 0;

        function setupItemInteractions(el) {
            el.onmousedown = (e) => {
                if (e.target.classList.contains('resize-handle')) {
                    initResize(e, el);
                    return;
                }
                // Text Editing
                if (e.target.classList.contains('note-content') || e.target.isContentEditable) {
                    e.stopPropagation();
                    return;
                }
                // Dragging
                dragged = el;
                document.querySelectorAll('.mb-item').forEach(i => i.classList.remove('selected'));
                el.classList.add('selected');

                const rect = el.getBoundingClientRect();
                dx = (e.clientX - rect.left) / zoomLevel;
                dy = (e.clientY - rect.top) / zoomLevel;
            };
        }

        window.onmousemove = (e) => {
            if (dragged) {
                const rect = mbCanvas.getBoundingClientRect();
                const x = (e.clientX - rect.left) / zoomLevel - dx;
                const y = (e.clientY - rect.top) / zoomLevel - dy;
                dragged.style.left = x + 'px';
                dragged.style.top = y + 'px';
            }
            if (resizing) {
                const w = r_w + (e.clientX - r_mx) / zoomLevel;
                const h = r_h + (e.clientY - r_my) / zoomLevel;
                resizing.style.width = Math.max(50, w) + 'px';
                resizing.style.height = Math.max(50, h) + 'px';
            }
        };

        window.onmouseup = () => { dragged = null; resizing = null; saveCurrent(); };

        function initResize(e, el) {
            e.stopPropagation();
            e.preventDefault();
            resizing = el;
            r_w = parseFloat(el.style.width || el.offsetWidth);
            r_h = parseFloat(el.style.height || el.offsetHeight);
            r_mx = e.clientX;
            r_my = e.clientY;
        }

        mbCanvas.addEventListener('dblclick', (e) => {
            if (e.target !== mbCanvas) return;
            const rect = mbCanvas.getBoundingClientRect();
            const x = (e.clientX - rect.left) / zoomLevel;
            const y = (e.clientY - rect.top) / zoomLevel;
            createStickyAt(x - 125, y - 125);
        });

        // --- TABS & TOOLS ---
        function switchTab(t) {
            activeTab = t;
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.view-layer').forEach(l => l.classList.remove('active'));
            document.getElementById('btn-' + t).classList.add('active');
            document.getElementById('view-' + t).classList.add('active');
        }

        function execCmd(c, v) {
            document.execCommand(c, false, v);
            if (activeTab === 'moodboard' && document.activeElement.classList.contains('note-content')) {
                document.activeElement.focus();
            }
        }

        function applyColor(c) {
            if (activeTab === 'notepad') {
                execCmd('foreColor', c);
            } else {
                document.querySelectorAll('.mb-item.selected').forEach(el => {
                    if (el.classList.contains('mb-note')) {
                        el.style.backgroundColor = c;
                    }
                });
            }
        }

        // --- DATA ---
        function saveLocal() { localStorage.setItem('picha_data_v2', JSON.stringify(projects)); }
        function loadData() {
            try {
                const embedded = JSON.parse(document.getElementById('app-data').textContent);
                if (embedded.projects && embedded.projects.length) { projects = embedded.projects; return; }
            } catch (e) { }
            const loc = localStorage.getItem('picha_data_v2');
            if (loc) projects = JSON.parse(loc);
        }

        function saveSelf() {
            saveCurrent();
            let html = document.documentElement.outerHTML;
            const data = JSON.stringify({ projects });
            html = html.replace(/(<script id="app-data" type="application\/json">)([\s\S]*?)(<\/script>)/, `$1${data}$3`);
            download(new Blob([html], { type: 'text/html' }), `Picha_Notebook_${Date.now()}.html`);
        }

        function exportProject() {
            saveCurrent();
            const p = projects.find(x => x.id === activeProjectId);
            download(new Blob([JSON.stringify(p)], { type: 'application/json' }), `${p.name}.json`);
        }
        function backupAll() {
            saveCurrent();
            download(new Blob([JSON.stringify(projects)], { type: 'application/json' }), `Backup_All_${Date.now()}.json`);
        }

        function triggerImport() { document.getElementById('json-input').click(); }
        function handleImport(input) {
            const fr = new FileReader();
            fr.onload = (e) => {
                try {
                    const d = JSON.parse(e.target.result);
                    if (Array.isArray(d)) { projects = d; }
                    else { d.id = 'imp' + Date.now(); projects.unshift(d); }
                    renderSidebar(); loadProject(projects[0].id);
                } catch (err) { alert("Invalid JSON"); }
            };
            fr.readAsText(input.files[0]);
        }

        function download(blob, name) {
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = name; a.click();
        }
        function showToast(msg) {
            const t = document.getElementById('toast'); t.innerText = msg; t.style.opacity = 1;
            setTimeout(() => t.style.opacity = 0, 2000);
        }
    </script>
</body>

</html>
